{"version":3,"sources":["../src/diagramControl.js"],"names":["getColorForValue","data","value","console","info","debug","i","thresholds","length","colorMap","_","first","TimeSeries","kbn","MetricsPanelCtrl","diagramEditor","displayEditor","panelDefaults","initialZoom","colors","showLegend","maxDataPoints","mappingType","nullPointMode","format","valueName","valueMaps","op","text","content","init","startOnLoad","logLevel","cloneCssStyles","htmlLabels","useMaxWidth","diagramMarginX","diagramMarginY","actorMargin","width","height","boxMargin","boxTextMargin","noteMargin","messageMargin","mirrorActors","bottomMarginAdj","titleTopMargin","barHeight","barGap","topPadding","leftPadding","gridLineStartPadding","fontSize","fontFamily","numberSectionStyles","DiagramCtrl","$scope","$injector","$sce","defaults","panel","graphId","id","containerDivId","svg","events","on","onInitEditMode","bind","onDataReceived","initializeMermaid","mermaidAPI","initialize","parseError","handleParseError","err","hash","addEditorTab","dataList","series","map","seriesHandler","setValues","updateDiagram","render","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","$","remove","clearDiagram","_this","graphDefinition","renderCallback","svgCode","bindFunctions","updateStyle","trustAsHtml","key","seriesItem","targetElement","find","color","children","css","append","valueFormatted","html","colorData","split","strVale","Number","trim","lastPoint","last","lastValue","isArray","valueRounded","valueFormated","isString","escape","stats","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","decimals","scaledDecimals","roundValue","tmp","isNumber","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","scope","elem","attrs","ctrl","diagramElement","setElementHeight","renderingCompleted","templateUrl"],"mappings":"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","file":"diagramControl.js","sourcesContent":["import './libs/mermaid/dist/mermaidAPI';\r\nimport TimeSeries from 'app/core/time_series2';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {diagramEditor, displayEditor} from './properties';\r\nimport _ from 'lodash';\r\n//import './libs/mermaid/dist/mermaid.forest.css!'\r\nimport './diagram.css!'\r\n\r\nconst panelDefaults = {\r\n\tinitialZoom: 1,\r\n\tthresholds: '0,10',\r\n\tcolors: ['rgba(245, 54, 54, 0.9)', 'rgba(237, 129, 40, 0.89)', 'rgba(50, 172, 45, 0.97)'],\r\n\tshowLegend: true,\r\n\tmaxDataPoints: 100,\r\n\tmappingType: 1,\r\n\tnullPointMode: 'connected',\r\n\tformat: 'none',\r\n\tvalueName: 'avg',\r\n    valueMaps: [\r\n      { value: 'null', op: '=', text: 'N/A' }\r\n    ],\r\n    content: 'graph LR\\n' +\r\n\t\t'A[Square Rect] -- Link text --> B((Circle))\\n' +\r\n\t\t'A --> C(Round Rect)\\n' +\r\n\t\t'B --> D{Rhombus}\\n' +\r\n\t\t'C --> D\\n',\r\n\tinit: {\r\n\t\tstartOnLoad: false,\r\n\t\tlogLevel: 2, //1:debug, 2:info, 3:warn, 4:error, 5:fatal\r\n    \tcloneCssStyles: false, // - This options controls whether or not the css rules should be copied into the generated svg\r\n\t\tstartOnLoad: false, // - This options controls whether or mermaid starts when the page loads\r\n\t\tarrowMarkerAbsolute: true, // - This options controls whether or arrow markers in html code will be absolute paths or an anchor, #. This matters if you are using base tag settings.\r\n\t\tflowchart: {\r\n\t\t\thtmlLabels: true,\r\n\t\t\tuseMaxWidth: true\r\n\t\t},\r\n\t\tsequenceDiagram: {\r\n\t\t\tdiagramMarginX: 50, // - margin to the right and left of the sequence diagram\r\n\t\t\tdiagramMarginY: 10, // - margin to the over and under the sequence diagram\r\n\t\t\tactorMargin: 50, // - Margin between actors\r\n\t\t\twidth: 150, // - Width of actor boxes\r\n\t\t\theight: 65, // - Height of actor boxes00000000001111\r\n\t\t\tboxMargin: 10, // - Margin around l01oop boxes\r\n\t\t\tboxTextMargin: 5, // - margin around the text in loop/alt/opt boxes\r\n\t\t\tnoteMargin: 10, // - margin around notes\r\n\t\t\tmessageMargin: 35, // - Space between messages\r\n\t\t\tmirrorActors: true, // - mirror actors under diagram\r\n\t\t\tbottomMarginAdj: 1, // - Depending on css styling this might need adjustment. Prolongs the edge of the diagram downwards\r\n\t\t\tuseMaxWidth: true, // - when this flag is set the height and width is set to 100% and is then scaling with the available space if not the absolute space required is used\r\n\t\t},\r\n\t\tgantt: {\r\n\t\t\ttitleTopMargin: 25, // - margin top for the text over the gantt diagram\r\n\t\t\tbarHeight: 20, // - the height of the bars in the graph\r\n\t\t\tbarGap: 4, // - the margin between the different activities in the gantt diagram\r\n\t\t\ttopPadding: 50, // - margin between title and gantt diagram and between axis and gantt diagram.\r\n\t\t\tleftPadding: 75, // - the space allocated for the section name to the left of the activities.\r\n\t\t\tgridLineStartPadding: 35, // - Vertical starting position of the grid lines\r\n\t\t\tfontSize: 11, // - font size ...\r\n\t\t\tfontFamily: '\"Open-Sans\", \"sans-serif\"', // - font family ...\r\n\t\t\tnumberSectionStyles: 3, // - the number of alternating section styles\r\n\t\t\t/** axisFormatter: // - formatting of the axis, this might need adjustment to match your locale and preferences\r\n\t\t\t\t[\r\n\t\t        // Within a day\r\n\t\t        ['%I:%M', function (d) {\r\n\t\t            return d.getHours();\r\n\t\t        }],\r\n\t\t        // Monday a week\r\n\t\t        ['w. %U', function (d) {\r\n\t\t            return d.getDay() == 1;\r\n\t\t        }],\r\n\t\t        // Day within a week (not monday)\r\n\t\t        ['%a %d', function (d) {\r\n\t\t            return d.getDay() && d.getDate() != 1;\r\n\t\t        }],\r\n\t\t        // within a month\r\n\t\t        ['%b %d', function (d) {\r\n\t\t            return d.getDate() != 1;\r\n\t\t        }],\r\n\t\t        // Month\r\n\t\t        ['%m-%y', function (d) {\r\n\t\t            return d.getMonth();\r\n\t\t        }]] **/\r\n\t\t},\r\n\t\tclassDiagram: {},\r\n    \tinfo: {}\r\n\t}\r\n};\r\n\r\nclass DiagramCtrl extends MetricsPanelCtrl {\r\n\tconstructor($scope, $injector, $sce) {\r\n\t\tsuper($scope, $injector);\r\n\t\t_.defaults(this.panel, panelDefaults);\r\n\t\t\r\n\t\tthis.panel.graphId = 'diagram_' + this.panel.id;\r\n\t\tthis.containerDivId = 'container_'+this.panel.graphId;\r\n\t\tthis.svg = {};\t\t\r\n\t\tthis.$sce = $sce;\r\n\t\tthis.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\r\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n\t\tthis.initializeMermaid();\r\n\t}\r\n\t\r\n\tinitializeMermaid(){\r\n\t\tmermaidAPI.initialize(this.panel.init);\r\n\t\tmermaidAPI.parseError = this.handleParseError.bind(this);\r\n\t}\r\n\t\r\n\thandleParseError(err, hash){\r\n\t\tthis.svg = '<p>Diagram Definition:</p><pre>' + err + '</pre>';\r\n\t}\r\n\t\r\n\tonInitEditMode() {\r\n\t\tthis.addEditorTab('Diagram', diagramEditor, 2);\r\n\t\tthis.addEditorTab('Display', displayEditor, 3);\r\n\t}\r\n\t\r\n\tonDataReceived(dataList){\r\n\t\tconsole.info('received data');\r\n\t\tconsole.debug(dataList);\r\n\t\tthis.series = dataList.map(this.seriesHandler.bind(this));\r\n\t\tconsole.info('mapped dataList to series');\r\n\t\tconsole.debug(this.series);\r\n\r\n\t\tvar data = {};\r\n\t\tthis.setValues(data);\r\n\t\tthis.updateDiagram(data);\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tseriesHandler(seriesData) {\r\n\t\tvar series = new TimeSeries({\r\n\t\t\tdatapoints: seriesData.datapoints,\r\n\t\t\talias: seriesData.target,\r\n\t\t});\r\n\t    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n\t    return series;\r\n\t} // End seriesHandler()\r\n\t\r\n\tclearDiagram(){\r\n\t\t$('#'+this.panel.graphId).remove();\r\n\t\tthis.svg = {};\r\n\t}\r\n\r\n\tupdateDiagram(data){\r\n\t\tif(this.panel.content.length > 0){\r\n\t\t\tthis.clearDiagram();\r\n\t\t\tvar _this = this;\r\n\t\t\tvar graphDefinition = this.panel.content;\r\n\t\t\tvar renderCallback = function (svgCode, bindFunctions){\r\n\t\t\t    var svg = _this.updateStyle(svgCode, data);\r\n\t\t\t    _this.svg = _this.$sce.trustAsHtml(svg);\r\n\t\t\t};\r\n\t\t    mermaidAPI.render(this.panel.graphId, graphDefinition, renderCallback);\r\n\t\t}\r\n\t} // End updateDiagram()\r\n\t\r\n\tupdateStyle(svgCode, data){\r\n\t\tconsole.info('updating svg style');\r\n\t\tvar svg = $('<div>' + svgCode + '</div>');\r\n\t\tfor(var key in data){\r\n\t\t\tvar seriesItem = data[key];\r\n\t\t\tvar targetElement = $(svg).find('#'+key).first();\r\n\t\t\tconsole.info('setting node:' + key + ' to color:' + seriesItem.color);\r\n\t\t\ttargetElement.children().css('fill', seriesItem.color);\r\n\t\t\ttargetElement.find('div').first().append('<p class=\"diagram-value\" style=\"background-color:'+seriesItem.color+'\">'+seriesItem.valueFormatted+'</p>');\r\n\t\t}\r\n\t\treturn $(svg).html();\r\n\t} // End updateStyle()\r\n\t\r\n\tsetValues(data) {\r\n\t\tvar colorData = {};\r\n\t\tconsole.info('using thresholds');\r\n\t\tconsole.debug(this.panel.thresholds);\r\n\t\tconsole.debug(this.panel.thresholds.split(','));\r\n\t\tcolorData.thresholds = this.panel.thresholds.split(',').map(function(strVale) {\r\n\t\t\treturn Number(strVale.trim());\r\n\t\t});\r\n\t\tcolorData.colorMap = this.panel.colors;\r\n\t\t\r\n\t    if (this.series && this.series.length > 0) {\r\n\t\t\tfor(var i = 0; i < this.series.length; i++){\r\n\t\t\t\tvar seriesItem = this.series[i];\r\n\t\t\t\tconsole.debug('setting values for series');\r\n\t\t\t\tconsole.debug(seriesItem);\r\n\t\t\t\tdata[seriesItem.alias] = {};\r\n\t\t\t\tvar lastPoint = _.last(seriesItem.datapoints);\r\n\t\t\t    var lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\r\n\t\t\t\r\n\t\t\t\tif (this.panel.valueName === 'name') {\r\n\t\t\t\t\tdata[seriesItem.alias].value = 0;\r\n\t\t\t        data[seriesItem.alias].valueRounded = 0;\r\n\t\t\t        data[seriesItem.alias].valueFormated = seriesItem.alias;\r\n\t\t\t\t} else if (_.isString(lastValue)) {\r\n\t\t\t        data[seriesItem.alias].value = 0;\r\n\t\t\t        data[seriesItem.alias].valueFormated = _.escape(lastValue);\r\n\t\t\t        data[seriesItem.alias].valueRounded = 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdata[seriesItem.alias].value = seriesItem.stats[this.panel.valueName];\r\n\t\t\t        //data[seriesItem.alias].flotpairs = seriesItem.flotpairs;\r\n\t\t\t\r\n\t\t\t        var decimalInfo = this.getDecimalsForValue(data[seriesItem.alias].value);\r\n\t\t\t        var formatFunc = kbn.valueFormats[this.panel.format];\r\n\t\t\t        data[seriesItem.alias].valueFormatted = formatFunc(data[seriesItem.alias].value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n\t\t\t        data[seriesItem.alias].valueRounded = kbn.roundValue(data[seriesItem.alias].value, decimalInfo.decimals);\r\n\t\t\t\t}\r\n\t\t\t\tdata[seriesItem.alias].color = getColorForValue(colorData, data[seriesItem.alias].value);\r\n\t\t\t}\r\n\t    }\r\n\t} // End setValues()\r\n\t\r\n\tinvertColorOrder() {\r\n\t    var tmp = this.panel.colors[0];\r\n\t    this.panel.colors[0] = this.panel.colors[2];\r\n\t    this.panel.colors[2] = tmp;\r\n\t}\r\n\r\n\tgetDecimalsForValue(value) {\r\n\t    if (_.isNumber(this.panel.decimals)) {\r\n\t      return {decimals: this.panel.decimals, scaledDecimals: null};\r\n\t    }\r\n\r\n\t    var delta = value / 2;\r\n\t    var dec = -Math.floor(Math.log(delta) / Math.LN10);\r\n\t\r\n\t    var magn = Math.pow(10, -dec),\r\n\t      norm = delta / magn, // norm is between 1.0 and 10.0\r\n\t      size;\r\n\t\r\n\t    if (norm < 1.5) {\r\n\t      size = 1;\r\n\t    } else if (norm < 3) {\r\n\t      size = 2;\r\n\t      // special case for 2.5, requires an extra decimal\r\n\t      if (norm > 2.25) {\r\n\t        size = 2.5;\r\n\t        ++dec;\r\n\t      }\r\n\t    } else if (norm < 7.5) {\r\n\t      size = 5;\r\n\t    } else {\r\n\t      size = 10;\r\n\t    }\r\n\t\r\n\t    size *= magn;\r\n\t\r\n\t    // reduce starting decimals if not needed\r\n\t    if (Math.floor(value) === value) { dec = 0; }\r\n\t\r\n\t    var result = {};\r\n\t    result.decimals = Math.max(0, dec);\r\n\t    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\t\r\n\t    return result;\r\n\t}\r\n\t\r\n\tlink(scope, elem, attrs, ctrl) {\r\n\t    var diagramElement = elem.find('.diagram');\r\n    \tconsole.debug('found diagram panel');\r\n    \tconsole.debug(diagramElement);\r\n    \telem.css('height', ctrl.height + 'px');\r\n    \t\r\n    \tfunction render(){\r\n    \t\tsetElementHeight();\r\n    \t}\r\n    \t\r\n    \tfunction setElementHeight() {\r\n\t      diagramElement.css('height', ctrl.height + 'px');\r\n\t    }\r\n    \t\r\n    \tthis.events.on('render', function() {\r\n\t\t\trender();\r\n\t\t\tctrl.renderingCompleted();\r\n\t    });\r\n\t}\r\n// End Class\r\n}\r\n\r\nfunction getColorForValue(data, value) {\r\n\tconsole.info('Getting color for value');\r\n\tconsole.debug(data);\r\n\tconsole.debug(value);\r\n\tfor (var i = data.thresholds.length; i > 0; i--) {\r\n\t\tif (value >= data.thresholds[i-1]) {\r\n\t\treturn data.colorMap[i];\r\n\t}\r\n  }\r\n  return _.first(data.colorMap);\r\n}\r\n\r\nDiagramCtrl.templateUrl = 'module.html';\r\n\r\nexport {\r\n\tDiagramCtrl,\r\n\tDiagramCtrl as MetricsPanelCtrl\r\n};"]}